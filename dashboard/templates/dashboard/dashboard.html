{% extends 'base.html' %}

{% block title %}Panel de Control{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="text-center fw-bold">Panel de Control</h1>
    <p class="text-center text-muted">Visualiza el rendimiento de los técnicos y los servicios en tiempo real.</p>

    <!-- Gráficas de rendimiento -->
    <div class="row justify-content-center my-4">
        <div class="col-md-6 text-center">
            <h3>Rendimiento de los Técnicos</h3>
            <canvas id="technicianPerformanceChart"></canvas>
        </div>
        <div class="col-md-6 text-center">
            <h3>Servicios Completados por Mes</h3>
            <canvas id="monthlyCompletedServicesChart"></canvas>
        </div>
    </div>

    <!-- Tabla de KPIs -->
    <h2 class="mt-5">Indicadores Clave de Rendimiento (KPIs)</h2>
    <table class="table table-striped text-center mt-3">
        <thead class="table-dark">
            <tr>
                <th>Técnico</th>
                <th>Servicios Completados</th>
                <th>Puntuación de Clientes</th>
                <th>Tiempo Medio de Resolución (días)</th>
            </tr>
        </thead>
        <tbody>
            {% for tecnico in tecnicos_kpis %}
                <tr>
                    <td>{{ tecnico.nombre }}</td>
                    <td>{{ tecnico.total_servicios_completados|default:"0" }}</td>
                    <td>{{ tecnico.puntuacion_clientes|floatformat:2|default:"N/A" }}</td>
                    <td>{{ tecnico.tiempo_resolucion.days|default:"N/A" }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Tabla de rendimiento de técnicos -->
    <h2 class="mt-5">Rendimiento de los Técnicos</h2>
    <table class="table table-hover text-center mt-3">
        <thead class="table-dark">
            <tr>
                <th>Técnico</th>
                <th>Servicios Realizados</th>
                <th>Rendimiento (%)</th>
                <th>Total Puntos</th>
                <th>Logros</th>
            </tr>
        </thead>
        <tbody>
            {% for tecnico in tecnicos_rendimiento %}
                <tr>
                    <td>{{ tecnico.nombre }}</td>
                    <td>{{ tecnico.servicios_realizados }}</td>
                    <td>{{ tecnico.rendimiento|floatformat:2|default:"0" }}%</td>
                    <td>{{ tecnico.total_puntos|default:"0" }}</td>
                    <td>{{ tecnico.logros|default:"0" }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Retos dinámicos -->
    <h2 class="mt-5 text-center">Retos a conseguir</h2>
    <div class="row justify-content-center">
        {% for reto in retos %}
        <div class="col-md-4 mb-3">
            <div class="card text-center shadow-sm p-3">
                <h5 class="fw-bold">{{ reto.nombre }}</h5>
                <p>{{ reto.descripcion }}</p>
                <p><strong>Recompensa:</strong> {{ reto.puntos_otorgados }} puntos</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Progreso general de técnicos -->
    <h2 class="mt-5">Proceso General de Técnicos</h2>
    <table class="table table-hover text-center mt-3">
        <thead class="table-dark">
            <tr>
                <th>Técnico</th>
                <th>Progreso de Servicios</th>
                <th>Puntos Totales</th>
                <th>Último Logro</th>
            </tr>
        </thead>
        <tbody>
            {% for tecnico in tecnicos_proceso %}
                <tr>
                    <td>{{ tecnico.nombre }}</td>
                    <td>{{ tecnico.progreso_servicios|default:"0" }}</td>
                    <td>{{ tecnico.puntos_totales|default:"0" }}</td>
                    <td>{{ tecnico.ultimo_logro|default:"Sin logros" }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Gráficas -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const technicianPerformanceData = {{ servicios_por_tecnico|safe }};
    const monthlyServicesData = {{ servicios_por_mes|safe }};

    new Chart(document.getElementById('technicianPerformanceChart'), {
        type: 'bar',
        data: {
            labels: technicianPerformanceData.map(item => item.tecnico__nombre),
            datasets: [{ label: 'Servicios Completados', data: technicianPerformanceData.map(item => item.total) }]
        },
        options: { responsive: true }
    });

    new Chart(document.getElementById('monthlyCompletedServicesChart'), {
        type: 'line',
        data: {
            labels: monthlyServicesData.map(item => `Mes ${item.mes}`),
            datasets: [{ label: 'Servicios Completados', data: monthlyServicesData.map(item => item.total) }]
        },
        options: { responsive: true }
    });
</script>
{% endblock %}