{% extends "base.html" %}

{% block title %}Guías Recomendadas{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Servicio: {{ current_service.equipo.marca }} {{ current_service.equipo.modelo }} ({{ current_service.equipo.anio }})</h1>
        <a href="{% url 'tecnico_services_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Mis Servicios
        </a>
    </div>

    <h2>Guías Recomendadas:</h2>

    <div class="list-group" id="guides-container">
        {% for guide in similar_guides %}
            <div class="list-group-item">
                <h3 class="guia-titulo">{{ guide.titulo }}</h3>
                <p class="guia-descripcion">{{ guide.descripcion }}</p>
                <button class="btn btn-info preview-btn" data-guide="{{ guide.id }}">
                    <i class="fas fa-eye"></i> Previsualizar
                </button>
                <div class="guia-links mt-2">
                    {% if guide.manual %}
                        <a href="{{ guide.manual }}" class="btn btn-primary" target="_blank">
                            <i class="fas fa-book"></i> Ver Manual
                        </a>
                    {% else %}
                        <p class="text-muted">Sin manual disponible.</p>
                    {% endif %}
                    {% if guide.video %}
                        <a href="{{ guide.video }}" class="btn btn-secondary" target="_blank">
                            <i class="fas fa-video"></i> Ver Video
                        </a>
                    {% else %}
                        <p class="text-muted">Sin video disponible.</p>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <div class="list-group-item text-center">No se encontraron guías similares.</div>
        {% endfor %}
    </div>

    <!-- Modal para previsualizar guías -->
    <div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="previewModalLabel">Previsualización de Guía</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body" id="modalContent">
                    <p>Cargando...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript para manejar la previsualización -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const previewButtons = document.querySelectorAll(".preview-btn");

        previewButtons.forEach(button => {
            button.addEventListener("click", function () {
                const guideId = this.getAttribute("data-guide");

                // Mostrar el modal
                const modal = new bootstrap.Modal(document.getElementById("previewModal"));
                modal.show();

                // Cargar contenido de la guía
                const modalContent = document.getElementById("modalContent");
                modalContent.innerHTML = "<p>Cargando...</p>";

                fetch(`/servicios/api/guide_preview/${guideId}/`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Error al obtener la previsualización.");
                        }
                        return response.json();
                    })
                    .then(data => {
                        const videoEmbed = data.video_url
                            ? `<iframe src="${data.video_url}" width="100%" height="400" frameborder="0" allowfullscreen></iframe>`
                            : "<p class='text-muted'>Sin video disponible.</p>";

                        const manualLink = data.manual_url
                            ? `<a href="${data.manual_url}" target="_blank" class="btn btn-primary">Ver Manual Completo</a>`
                            : "<p class='text-muted'>Sin manual disponible.</p>";

                        modalContent.innerHTML = `
                            <h3>${data.titulo}</h3>
                            <p>${data.descripcion}</p>
                            ${manualLink}
                            <div class="mt-3">${videoEmbed}</div>
                        `;
                    })
                    .catch(error => {
                        modalContent.innerHTML = `<p class="text-danger">Error al cargar la previsualización.</p>`;
                    });
            });
        });
    });
</script>
{% endblock %}