{% extends "base.html" %}
{% block title %}Administraci√≥n de Gamificaci√≥n{% endblock %}
{% block content %}
<div class="container mt-5">
    <h1 class="text-center text-primary mb-4">üéÆ Administraci√≥n de Gamificaci√≥n</h1>

    <!-- Otorgar Puntos -->
    <h2 class="mt-5 text-secondary">‚ú® Otorgar Puntos</h2>
    <form method="post" class="mb-3 shadow p-4 rounded bg-light">
        {% csrf_token %}
        {{ otorgar_puntos_form.as_p }}
        <input type="hidden" name="action" value="otorgar_puntos">
        <button class="btn btn-success btn-lg w-100">Otorgar Puntos</button>
    </form>

    <!-- Temporadas -->
    <!-- Formulario para crear temporadas -->
    <h2 class="mt-5 text-secondary">üìÖ Temporadas</h2>
    <form id="form-crear-temporada" class="mb-3 shadow p-4 rounded bg-light">
        {% csrf_token %}
        {{ temporada_form.as_p }}
        <button type="submit" class="btn btn-success btn-lg w-100">Crear Temporada</button>
    </form>
    <ul id="lista-temporadas" class="list-group mb-5">
        {% for temporada in temporadas %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
                <strong>{{ temporada.nombre }}</strong> ({{ temporada.fecha_inicio }} - {{ temporada.fecha_fin }})
            </span>
            <form method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="temporada_id" value="{{ temporada.id }}">
                <button class="btn btn-sm btn-danger">Eliminar</button>
            </form>
        </li>
        {% empty %}
        <li class="list-group-item text-center">No hay temporadas registradas.</li>
        {% endfor %}
    </ul>
    <div class="d-flex justify-content-center">
        {% if temporadas.has_other_pages %}
        <nav>
            <ul class="pagination">
                {% if temporadas.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?temporadas_page={{ temporadas.previous_page_number }}">Anterior</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <a class="page-link">Anterior</a>
                </li>
                {% endif %}

                {% for page_num in temporadas.paginator.page_range %}
                {% if temporadas.number == page_num %}
                <li class="page-item active"><a class="page-link">{{ page_num }}</a></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="?temporadas_page={{ page_num }}">{{ page_num }}</a></li>
                {% endif %}
                {% endfor %}

                {% if temporadas.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?temporadas_page={{ temporadas.next_page_number }}">Siguiente</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <a class="page-link">Siguiente</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>

    <!-- Retos -->
    <!-- Formulario para crear retos -->
    <h2 class="mt-5 text-secondary">üìú Retos</h2>
    <form id="form-crear-reto" class="mb-3 shadow p-4 rounded bg-light">
        {% csrf_token %}
        {{ reto_form.as_p }}
        <button type="submit" class="btn btn-success btn-lg w-100">Crear Reto</button>
    </form>
    <ul id="lista-retos" class="list-group mb-5">
        {% for reto in retos %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
                <strong>{{ reto.nombre }}</strong> (Nivel: {{ reto.nivel }})
            </span>
            <form method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="reto_id" value="{{ reto.id }}">
                <button class="btn btn-sm btn-danger">Eliminar</button>
            </form>
        </li>
        {% empty %}
        <li class="list-group-item text-center">No hay retos registrados.</li>
        {% endfor %}
    </ul>
    <div class="d-flex justify-content-center">
        {% if retos.has_other_pages %}
        <nav>
            <ul class="pagination">
                {% if retos.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?retos_page={{ retos.previous_page_number }}">Anterior</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <a class="page-link">Anterior</a>
                </li>
                {% endif %}

                {% for page_num in retos.paginator.page_range %}
                {% if retos.number == page_num %}
                <li class="page-item active"><a class="page-link">{{ page_num }}</a></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="?retos_page={{ page_num }}">{{ page_num }}</a></li>
                {% endif %}
                {% endfor %}

                {% if retos.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?retos_page={{ retos.next_page_number }}">Siguiente</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <a class="page-link">Siguiente</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>

    <!-- Recompensas -->
    <!-- Formulario para crear recompensas -->
    <h2 class="mt-5 text-secondary">üéÅ Recompensas</h2>
    <form id="form-crear-recompensa" class="mb-3 shadow p-4 rounded bg-light">
        {% csrf_token %}
        {{ recompensa_form.as_p }}
        <button type="submit" class="btn btn-success btn-lg w-100">Crear Recompensa</button>
    </form>
    <ul id="lista-recompensas" class="list-group mb-5">
        {% for recompensa in recompensas %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
                <strong>{{ recompensa.descripcion }}</strong> ({{ recompensa.tipo }})
            </span>
            <form method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="recompensa_id" value="{{ recompensa.id }}">
                <button class="btn btn-sm btn-danger">Eliminar</button>
            </form>
        </li>
        {% empty %}
        <li class="list-group-item text-center">No hay recompensas registradas.</li>
        {% endfor %}
    </ul>
    <div class="d-flex justify-content-center">
        {% if recompensas.has_other_pages %}
        <nav>
            <ul class="pagination">
                {% if recompensas.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?recompensas_page={{ recompensas.previous_page_number }}">Anterior</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <a class="page-link">Anterior</a>
                </li>
                {% endif %}

                {% for page_num in recompensas.paginator.page_range %}
                {% if recompensas.number == page_num %}
                <li class="page-item active"><a class="page-link">{{ page_num }}</a></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="?recompensas_page={{ page_num }}">{{ page_num }}</a></li>
                {% endif %}
                {% endfor %}

                {% if recompensas.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?recompensas_page={{ recompensas.next_page_number }}">Siguiente</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <a class="page-link">Siguiente</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>

    <!-- Medallas -->
    <!-- Formulario para crear medallas -->
    <h2 class="mt-5 text-secondary">üèÖ Medallas</h2>
    <form id="form-crear-medalla" class="mb-3 shadow p-4 rounded bg-light" enctype="multipart/form-data">
        {% csrf_token %}
        {{ medalla_form.as_p }}
        <button type="submit" class="btn btn-success btn-lg w-100">Crear Medalla</button>
    </form>
    <ul id="lista-medallas" class="list-group mb-5">
        {% for medalla in medallas %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
                <strong>{{ medalla.nombre }}</strong> (Nivel: {{ medalla.nivel_requerido }})
            </span>
            <form method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="medalla_id" value="{{ medalla.id }}">
                <button class="btn btn-sm btn-danger">Eliminar</button>
            </form>
        </li>
        {% empty %}
        <li class="list-group-item text-center">No hay medallas registradas.</li>
        {% endfor %}
    </ul>
    <div class="d-flex justify-content-center">
        {% if medallas.has_other_pages %}
        <nav>
            <ul class="pagination">
                {% if medallas.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?medallas_page={{ medallas.previous_page_number }}">Anterior</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <a class="page-link">Anterior</a>
                </li>
                {% endif %}

                {% for page_num in medallas.paginator.page_range %}
                {% if medallas.number == page_num %}
                <li class="page-item active"><a class="page-link">{{ page_num }}</a></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="?medallas_page={{ page_num }}">{{ page_num }}</a></li>
                {% endif %}
                {% endfor %}

                {% if medallas.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?medallas_page={{ medallas.next_page_number }}">Siguiente</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <a class="page-link">Siguiente</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<script>
// Script para crear temporada
document.getElementById('form-crear-temporada').addEventListener('submit', function (e) {
    e.preventDefault(); // Evitar recargar la p√°gina

    const form = e.target;
    const formData = new FormData(form);

    fetch('{% url "crear_temporada_ajax" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar la lista de temporadas
            const lista = document.getElementById('lista-temporadas');
            const nuevaTemporada = `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        <strong>${data.temporada.nombre}</strong> (${data.temporada.fecha_inicio} - ${data.temporada.fecha_fin})
                    </span>
                </li>`;
            lista.insertAdjacentHTML('beforeend', nuevaTemporada);

            // Limpiar el formulario
            form.reset();
        } else {
            alert('Error al crear la temporada: ' + JSON.stringify(data.errors));
        }
    })
    .catch(error => console.error('Error:', error));
});

// Script para crear reto
document.getElementById('form-crear-reto').addEventListener('submit', function (e) {
    e.preventDefault(); // Evitar recargar la p√°gina

    const form = e.target;
    const formData = new FormData(form);

    fetch('{% url "crear_reto_ajax" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar la lista de retos
            const lista = document.getElementById('lista-retos');
            const nuevoReto = `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        <strong>${data.reto.nombre}</strong> (Nivel: ${data.reto.nivel})
                    </span>
                </li>`;
            lista.insertAdjacentHTML('beforeend', nuevoReto);

            // Limpiar el formulario
            form.reset();
        } else {
            alert('Error al crear el reto: ' + JSON.stringify(data.errors));
        }
    })
    .catch(error => console.error('Error:', error));
});

// Script para crear recompensa
document.getElementById('form-crear-recompensa').addEventListener('submit', function (e) {
    e.preventDefault(); // Evitar recargar la p√°gina

    const form = e.target;
    const formData = new FormData(form);

    fetch('{% url "crear_recompensa_ajax" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar la lista de recompensas
            const lista = document.getElementById('lista-recompensas');
            const nuevaRecompensa = `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        <strong>${data.recompensa.descripcion}</strong> (${data.recompensa.tipo})
                    </span>
                </li>`;
            lista.insertAdjacentHTML('beforeend', nuevaRecompensa);

            // Limpiar el formulario
            form.reset();
        } else {
            alert('Error al crear la recompensa: ' + JSON.stringify(data.errors));
        }
    })
    .catch(error => console.error('Error:', error));
});

// Script para crear medalla
document.getElementById('form-crear-medalla').addEventListener('submit', function (e) {
    e.preventDefault(); // Evitar recargar la p√°gina

    const form = e.target;
    const formData = new FormData(form);

    fetch('{% url "crear_medalla_ajax" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Actualizar la lista de medallas
            const lista = document.getElementById('lista-medallas');
            const nuevaMedalla = `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <span>
                        <strong>${data.medalla.nombre}</strong> (Nivel: ${data.medalla.nivel_requerido})
                    </span>
                </li>`;
            lista.insertAdjacentHTML('beforeend', nuevaMedalla);

            // Limpiar el formulario
            form.reset();
        } else {
            alert('Error al crear la medalla: ' + JSON.stringify(data.errors));
        }
    })
    .catch(error => console.error('Error:', error));
});
</script>

{% endblock %}